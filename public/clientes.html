<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Clientes - Diesel Ctrl</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-slate-50 min-h-screen text-slate-900">
    <nav class="bg-slate-900 text-white p-4 shadow-lg flex justify-between items-center">
        <div class="font-black tracking-tight">Diesel Ctrl</div>
        <div class="text-xs uppercase font-semibold">Gestión de Clientes</div>
        <a href="/index.html" class="text-sm underline">Volver a ventas</a>
    </nav>

    <main class="container mx-auto p-4 grid grid-cols-1 lg:grid-cols-12 gap-6">
        <section class="lg:col-span-5 bg-white rounded-2xl shadow-sm border border-slate-200 p-5 space-y-4">
            <h2 class="text-sm font-black text-slate-500 uppercase tracking-widest">Formulario</h2>
            <div class="space-y-3">
                <div>
                    <label class="text-[11px] font-semibold text-slate-500">Nombre</label>
                    <input id="c_nombre" class="w-full p-3 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500 font-bold" placeholder="Ej. Juan Pérez">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <label class="text-[11px] font-semibold text-slate-500">Cédula</label>
                        <input id="c_cedula" class="w-full p-3 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500 font-bold" placeholder="V-00000000">
                    </div>
                    <div>
                        <label class="text-[11px] font-semibold text-slate-500">Teléfono</label>
                        <input id="c_telefono" class="w-full p-3 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500 font-bold" placeholder="0414-0000000">
                    </div>
                </div>
                <div class="flex gap-2">
                    <button id="btnGuardarCliente" class="flex-1 bg-blue-600 text-white p-3 rounded-xl font-bold hover:bg-blue-700 transition-colors"><i class="fas fa-save mr-2"></i>Guardar / Actualizar</button>
                    <button id="btnEliminarCliente" class="bg-red-100 text-red-700 p-3 rounded-xl font-bold hover:bg-red-200 transition-colors"><i class="fas fa-trash mr-2"></i>Eliminar</button>
                </div>
                <p class="text-[11px] text-slate-500">si la cédula existe, actualiza; si no, crea.</p>
            </div>
        </section>

        <section class="lg:col-span-7 bg-white rounded-2xl shadow-sm border border-slate-200 p-5 space-y-4">
            <div class="flex items-center justify-between gap-2">
                <h2 class="text-sm font-black text-slate-500 uppercase tracking-widest">Clientes</h2>
                <input id="c_buscar" placeholder="Buscar por nombre o cédula" class="flex-1 p-2 border rounded-lg text-sm" />
            </div>
            <div class="overflow-auto max-h-[70vh] border rounded-xl">
                <table class="w-full text-sm">
                    <thead class="bg-slate-100 text-[11px] uppercase text-slate-500">
                        <tr>
                            <th class="p-3 text-left">Nombre</th>
                            <th class="p-3 text-left">Cédula</th>
                            <th class="p-3 text-left">Teléfono</th>
                        </tr>
                    </thead>
                    <tbody id="c_tabla" class="divide-y"></tbody>
                </table>
            </div>
        </section>
    </main>

    <div id="toast" class="fixed right-4 bottom-4 space-y-2 z-50"></div>

    <script type="module">
        import { obtenerClientesFirebase, upsertClienteFirebase, eliminarClienteFirebasePorCedula } from './firebase-sync.js';

        const tabla = document.getElementById('c_tabla');
        const buscar = document.getElementById('c_buscar');
        const nombreInput = document.getElementById('c_nombre');
        const cedulaInput = document.getElementById('c_cedula');
        const telefonoInput = document.getElementById('c_telefono');
        const btnGuardar = document.getElementById('btnGuardarCliente');
        const btnEliminar = document.getElementById('btnEliminarCliente');
        const toast = document.getElementById('toast');

        let clientes = [];
        let seleccionado = null;

        function showToast(msg, type = 'info') {
            const el = document.createElement('div');
            el.className = `px-3 py-2 rounded-lg text-white shadow ${type === 'error' ? 'bg-red-600' : type === 'success' ? 'bg-green-600' : 'bg-slate-800'}`;
            el.innerText = msg;
            toast.appendChild(el);
            setTimeout(() => el.remove(), 2500);
        }

        function renderTabla(filtro = '') {
            const f = filtro.toLowerCase();
            const data = clientes.filter(c =>
                (c.nombre || '').toLowerCase().includes(f) ||
                (c.cedula || '').toLowerCase().includes(f)
            );
            tabla.innerHTML = data.map(c => `
                <tr class="hover:bg-slate-50 cursor-pointer" data-cedula="${c.cedula || ''}">
                    <td class="p-3 font-semibold text-slate-700">${c.nombre || ''}</td>
                    <td class="p-3 text-slate-600">${c.cedula || ''}</td>
                    <td class="p-3 text-slate-600">${c.telefono || ''}</td>
                </tr>
            `).join('');
        }

        function fillForm(c) {
            seleccionado = c || null;
            nombreInput.value = c?.nombre || '';
            cedulaInput.value = c?.cedula || '';
            telefonoInput.value = c?.telefono || '';
        }

        async function loadClientes() {
            try {
                clientes = await obtenerClientesFirebase();
            } catch (err) {
                console.error('No se pudieron obtener clientes', err);
                showToast('No se pudieron obtener clientes', 'error');
            }
            renderTabla(buscar.value.trim());
        }

        async function guardarCliente() {
            const cliente = {
                nombre: nombreInput.value.trim(),
                cedula: cedulaInput.value.trim(),
                telefono: telefonoInput.value.trim()
            };
            if (!cliente.nombre) { showToast('Nombre es requerido', 'error'); return; }
            try {
                await upsertClienteFirebase(cliente);
                showToast('Guardado/actualizado', 'success');
                await loadClientes();
                fillForm(null);
            } catch (err) {
                console.error(err);
                showToast('Error guardando', 'error');
            }
        }

        async function eliminarCliente() {
            const cedula = cedulaInput.value.trim();
            if (!cedula) { showToast('Cédula requerida para eliminar', 'error'); return; }
            try {
                await eliminarClienteFirebasePorCedula(cedula);
                showToast('Cliente eliminado', 'success');
                await loadClientes();
                fillForm(null);
            } catch (err) {
                console.error(err);
                showToast('Error eliminando', 'error');
            }
        }

        tabla.addEventListener('click', (e) => {
            const tr = e.target.closest('tr');
            if (!tr) return;
            const cedula = tr.dataset.cedula || '';
            const c = clientes.find(x => (x.cedula || '') === cedula);
            fillForm(c);
        });

        buscar.addEventListener('input', () => renderTabla(buscar.value.trim()));
        btnGuardar.addEventListener('click', guardarCliente);
        btnEliminar.addEventListener('click', eliminarCliente);

        loadClientes();
    </script>
</body>
</html>
